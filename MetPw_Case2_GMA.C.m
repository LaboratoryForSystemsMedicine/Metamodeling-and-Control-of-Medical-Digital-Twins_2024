
Par=[1e-5,1,0,0,0,0
     1e-4,0,1,0,0,0
     1e-4,0,0,1,0,0
     1e-4,0,1,0,0,0];

Par=[1.46102789514560e-08;0.000116249954980733;0.000103611213356883;6.73747266772434e-05;1.65773703154461;0.0273306084461001;0.00288017223565515;0.0169340394410486;-0.00518844347531567;1.09491492115765;0.00424872751612281;1.19985602993769;0.000685117349833135;0.00195109287944517;1.04365772443251;-0.0198493649915976;-0.00485487602352538;0.000779939522331078;-0.00192069830996051;-0.00374141552017736;-0.00762381750574003;-0.00293167802789445;-0.00268862686272783;-0.000306357298410539];

 Par=[40.46102789514560e-08,1.65773703154461,-0.200518844347531567,0.000685117349833135,-0.200485487602352538,-0.00762381750574003
     50.73747266772434e-05,0.0273306084461001,1.09491492115765,-0.200195109287944517,0.000779939522331078,-0.00293167802789445
     60e-5,0.00288017223565515,0.00424872751612281,1.04365772443251,-0.200192069830996051,-0.00268862686272783
     3.73747266772434e-05,0.0169340394410486,1.19985602993769,-0.0198493649915976,0.200374141552017736,-0.2000306357298410539];
 
%  Par=[6.03564453696475e-07;0.00153813761805611;0.00110286670012561;2.34723051574607e-06;1.78253401088908;-0.0151762465423794;0.00948806919832098;0.0210185957701100;-0.243592615224068;1.18119801954002;-0.00453838430521756;1.28819923824354;-0.00128676071270157;-0.309314502489783;0.934378290317753;-0.0417660951756425;-0.329109149393189;0.000512882944399370;-0.139258864519513;0.420726046748414;-0.00800690018679393;0.00514778271861283;-0.00694935784360148;-0.131187812153983]
%  Par=[1.95977517963435e-07;0.0105661179928686;0.0148146459472263;8.15221731734889e-06;1.90038058892746;0.142532513299660;0.196524717344480;0.144634109238897;-0.267504051045357;0.975271049608308;-0.104777108683216;1.14145401935352;0.0152079198438442;-0.435037470650966;0.751776948990351;-0.188643165246930;-0.406557778865942;-0.0150852160141991;-0.624754382963201;0.400816045326472;0.0495073376298112;-0.0494593885715811;0.260237434011125;-0.0944244334751264]
%  Par=[1.02233085393554e-07;0.0444139302443173;0.0129458733384482;1.80211924763599e-05;1.76335541206965;0.607319192857841;-0.454603109003654;-0.564959443624298;-0.123484802033558;0.704076343908550;0.477106801274089;0.587882463855541;0.0520664697104974;-0.948873658646137;0.268195488749100;0.422743556215675;-0.352254872029546;-0.151702076121980;0.266019048854812;0.558909003697651;0.0273220292370333;0.322943095014529;0.263733114145869;0.532201531380625]
 
Par=[7.18248911756627e-07;0.000448473724966763;0.000343295082326136;3.42017493568724e-05;1.62658232735929;0.0328045655606774;0.00283422192784520;0.0226138053540636;-0.145395421699771;1.14732035006985;0.00460634658301909;1.13570911410457;0.000716656135952573;-0.271447455666974;0.849612136446024;-0.0259153356859964;-0.273992273066820;0.000804016773050014;0.00674120386931101;0.328858478772431;-0.00459656837843866;-0.00194037187145371;-0.00136313337066546;-0.108547061481895]
Par=[5.18248504191837e-07;0.00210814439018989;0.000699018377490511;3.11616497220864e-06;1.64325530382748;-0.0199845528135532;-0.111662662816333;0.121339638690446;-0.0390139237716238;0.954333564004830;-0.231961193425026;1.04818554069586;-0.102380210200384;-0.307975888246232;1.16893653460439;-0.0736725896880275;-0.273164897441395;0.0326816466311685;-0.0673348661562358;0.380414802905383;0.0182104297435163;0.104854270568034;-0.0101229685578662;0.140846989216674]
Par=[5.78574878106417e-07;0.00281456091691111;0.00124232396096317;5.12331326442794e-06;1.62833617781953;-0.0465637548254955;-0.113963781399390;0.112783034486250;0.00445345584875451;0.872330191827279;-0.117420317370712;1.03719788665174;-0.129767271207933;-0.290259251580989;1.04779505102492;-0.221544035008886;-0.274954039862835;0.105486215756956;-0.00779075768305025;0.389143115969059;0.0215531004375276;0.103375428546460;-0.0899864444860944;0.256995879685736]
Par=[8.15405870101156e-07;0.00226869865840180;0.00321460753592010;1.03237667563311e-05;1.58960913732377;-0.0708579151898338;-0.151337660627152;0.166707073749538;0.0119327054345222;0.881164520707943;-0.212969741614063;1.02624896532138;-0.131348299159889;-0.318145155421038;1.16142115997367;-0.331115703455059;-0.293698092540780;0.128687962107901;-0.0237139600211023;0.339993858934905;0.0441857743383156;0.155674943518520;-0.170171297089917;0.284122388517533]
Par=[1.04570209671084e-06;0.00253913082147378;0.00666224823583638;1.82352729986595e-05;1.51828032728551;0.00745320811227623;-0.119901824886251;0.125737912418823;0.0181704813603255;0.978589543884391;-0.226942355824724;0.949132869056921;-0.105419642799983;-0.515629090500241;1.10684260193799;-0.249558269531741;-0.328325927724993;0.114336714705949;-0.144803732498718;0.288822308144357;0.103419689861144;0.189645003606553;-0.107854207530049;0.307590875302249]
Par=[1.35939716481852e-06;0.00127214518054687;0.00572605969579028;1.67726005095733e-05;1.53041318641700;0.00837446337012014;-0.136324360317326;0.116011752773901;0.0222778098350775;0.944002484209128;-0.226922405774682;0.980587371499904;-0.131951117651073;-0.430574189070614;1.13511425556620;-0.269382670660199;-0.357661990043040;0.130019422186056;-0.116559246768366;0.302476278456397;0.112536754444753;0.185852839349874;-0.125790885857863;0.304453889708835]
Par=[1.61926852672036e-06;0.000741612677079295;0.00265552246760703;1.02925758018678e-05;1.50104230659948;0.0378355137821491;-0.139456963455349;0.0977909633200495;-0.0199791052453759;0.922802024790867;-0.128023013532234;0.988471491546846;-0.0741851318549526;-0.367835869624971;1.04843905099729;-0.219703174885892;-0.390870744358985;0.154607943564093;0.0283982753923157;0.286204858079137;0.133927981784889;0.139561662263629;-0.165363668898228;0.336268615889273]
Par=[4.74502612389625e-06;0.000576359760378815;0.000642466623136822;7.85977565820698e-06;1.35282138594707;0.0569435148011281;-0.153149363680334;0.120871561634369;-0.0379789448032409;0.981596331508223;-0.0530893910338475;0.936700877269385;-0.0294943641787164;-0.383989077829287;1.05225098122280;-0.124000363627265;-0.586631995453410;0.274938724540278;0.213826792475568;0.109795886506059;0.345231455337421;-0.00233237153850305;-0.235123077970914;0.445403185071512]

Par=[1.22128126448858e-05;0.000163012924488681;2.76257139454408e-05;3.24173655430097e-06;1.26196443470158;-0.0626846017593211;-0.0573142775492343;0.161599499324895;-0.0792128668273484;0.824312848831048;0.0870234829389650;0.670618797729081;-0.00476716019105887;0.101971681480395;1.02682021352590;0.319270881795275;-0.653096966067025;0.294463661409226;0.461013763856578;-0.0325601897740072;0.416732959385981;-0.103387173460410;-0.326335647348976;0.394090118910572]

% Par=[1.02797193909826e-05;0.000217658047287289;1.01322005785332e-05;1.86505848545290e-06;1.16520693340945;-0.0940291712139784;0.00813951876974418;0.196373630657710;-0.0302747156787509;0.739197614813986;0.0972736124652463;0.596461828679461;0.0262016492443841;0.234676812332482;1.03122564789036;0.425045435851156;-0.555598940104083;0.259499191501941;0.499826981615626;-0.0790007280799315;0.388276781557843;-0.124866554512083;-0.344524999555307;0.411951116879156]
% Par=[0.00270595874395440;0.0915455624778722;0.000915238403295641;0.00715902548238057;1.30417107348024;-0.0434933173786568;0.384105758331607;-0.0668968875758788;-0.254866528554665;0.547471900239930;-0.213151604687269;0.435700026116517;-0.0630063459019779;0.0573501028880305;0.826247438230893;0.341883111848523;-0.529463464045609;-0.174500728507968;0.151467465895348;-0.605086547526893;-0.112718203207009;-0.0960564150272877;-0.491284919860753;0.550286514355907]

% Par=Pars(:,59)
% Par=Pars(:,99)
load('FGMAwc4Lucas3')
Par=Pars(:,164)

if size(Par)==[4,6] 
    Par=Par(:);end
lst_ODE_model(Par,1)
drawnow

% options = optimset('Display','iter','MaxFunEvals',5000,'MaxIter',5000);
% new_par=fminsearch(@lst_ODE_model,Par,options,0)
% lst_ODE_model(new_par,1)

% % clear Lsts Pars
% new_par=Par;
% for n=100:350
% options = optimset('Display','final','MaxFunEvals',5000,'MaxIter',5000);
% new_par=fminsearch(@lst_ODE_model,new_par,options,0);
% Lsts(n)=lst_ODE_model(new_par,1);
% Pars(:,n)=new_par;
% figure(100); plot(Lsts);title('FGMAwc4L3')
% drawnow
% save('FGMAwc4Lucas3')
% end


return

function z=lst_ODE_model(Par,g)
load('temp123')
ok=0; 
Par(1:4)=abs(Par(1:4));

% load('Met_Pathwayv2_S80000_P20000_Q20000_noDil')
% temp=output(:,5);
% output(:,5)=output(:,6);
% output(:,6)=temp;

output=[0:1:length(temp1)-1]';
output=[output temp1];

Tspan=100:100000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6,'Events',@odeEvents);
tic
[t,y] = ode15s(@MetPathODE,Tspan,output(Tspan(1)+1,2:6),options,Par);
if or(t(end)<Tspan(end),any(imag(y)>0))
    ok=ok+1e12
end

if g==1
    figure(10)
    newcolors = [0.83 0.14 0.14
             1.00 0.54 0.00
             0.47 0.25 0.80
             0.25 0.80 0.54
             0.54 0.54 0.54];
         
         colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    hold on
    plot(output(:,1),output(:,2:end),'--', 'LineWidth', 1.5)
    hold off
    legend('S','P','Q','R','T')
    title('data_mean\simu_output_no_dilution_nohdr.dat')
    
end

dadosS=interp1(t,y,output(:,1));
lst=(dadosS-output(:,2:end)).^2;
lst(isnan(lst))=0;
lst1=sum(sum(lst));
     %%

% load('Met_Pathwayv2_S80000_P20000_Q20000_Dil0005In1.mat')
% temp=output(:,5);
% output(:,5)=output(:,6);
% output(:,6)=temp;

output=[0:1:length(temp2)-1]';
output=[output temp2];

Tspan=100:50000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6);
[t,y] = ode15s(@MetPathODE_flow,Tspan,output(Tspan(1)+1,2:6),options,Par,[1.0 0.0005]);
if t(end)<Tspan(end)
    ok=ok+1e12
end

if g==1
    figure(11)
    newcolors = [0.83 0.14 0.14
             1.00 0.54 0.00
             0.47 0.25 0.80
             0.25 0.80 0.54
             0.54 0.54 0.54];
         
         colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    hold on
    plot(output(:,1),output(:,2:end),'--', 'LineWidth', 1.5)
    hold off
    title('simu_output_dilution_feed_mean=1.0_nohdr.dat')
    
end

dadosS=interp1(t,y,output(:,1));
lst=(dadosS-output(:,2:end)).^2;
lst(isnan(lst))=0;
lst2=sum(sum(lst));
if any(y<0,'All')
        lst2=lst2*10;
%         'negativos'
    end
%%
output=[0:1:length(temp3)-1]';
output=[output temp3];

Tspan=100:50000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6);
[t,y] = ode15s(@MetPathODE_flow,Tspan,output(Tspan(1)+1,2:6),options,Par,[0.2 0.0005]);
if t(end)<Tspan(end)
    ok=ok+1e12
end

if g==1
    figure(12)
    newcolors = [0.83 0.14 0.14
             1.00 0.54 0.00
             0.47 0.25 0.80
             0.25 0.80 0.54
             0.54 0.54 0.54];
         
         colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    hold on
    plot(output(:,1),output(:,2:end),'--', 'LineWidth', 1.5)
    hold off
    title('simu_output_dilution_feed_mean=0.2_nohdr.dat')
    assignin('base','output',output(1:2000:end,:))
assignin('base','ty',[t(1:500:end) y(1:500:end,:)])
end

dadosS=interp1(t,y,output(:,1));
lst=(dadosS-output(:,2:end)).^2;
lst(isnan(lst))=0;
lst3=sum(sum(lst));
if any(y<0,'All')
        lst3=lst3*10;
%         'negativos'
    end
%%
if g==1
    [lst1 lst2 lst3]
end

z=lst1+lst2+lst3+ok;
end

function dxdt=MetPathODE(t,x,p) %This is the ODE function

MS=[-1,0,0,0;1,-1,0,-1;0,1,-1,0;0,0,1,0;0,0,0,1];
F=[p(1)*x(1)^p(5)*x(2)^p(9)*x(3)^p(13)*x(4)^p(17)*x(5)^p(21)  %1
   p(2)*x(1)^p(6)*x(2)^p(10)*x(3)^p(14)*x(4)^p(18)*x(5)^p(22)  %2
   p(3)*x(1)^p(7)*x(2)^p(11)*x(3)^p(15)*x(4)^p(19)*x(5)^p(23)  %3
   p(4)*x(1)^p(8)*x(2)^p(12)*x(3)^p(16)*x(4)^p(20)*x(5)^p(24)];  %4

dxdt=MS*F;

end
function dxdt=MetPathODE_flow(t,x,p,flow) %This is the ODE function
in=flow(1);
dil=flow(2);
MS=[-1,0,0,0;1,-1,0,-1;0,1,-1,0;0,0,1,0;0,0,0,1];
F=[p(1)*x(1)^p(5)*x(2)^p(9)*x(3)^p(13)*x(4)^p(17)*x(5)^p(21)  %1
   p(2)*x(1)^p(6)*x(2)^p(10)*x(3)^p(14)*x(4)^p(18)*x(5)^p(22)  %2
   p(3)*x(1)^p(7)*x(2)^p(11)*x(3)^p(15)*x(4)^p(19)*x(5)^p(23)  %3
   p(4)*x(1)^p(8)*x(2)^p(12)*x(3)^p(16)*x(4)^p(20)*x(5)^p(24)];  %4

dxdt=MS*F;

dxdt(1)=dxdt(1)+in;
dxdt=dxdt-x*dil;

end
function [value,isterminal,direction] = odeEvents(t,y,Par,SSa)
x=toc-10;
if x<0
    x=0;
end

value = x;     % Detect height = 0
isterminal = 1;   % Stop the integration
direction = 0;   
end
