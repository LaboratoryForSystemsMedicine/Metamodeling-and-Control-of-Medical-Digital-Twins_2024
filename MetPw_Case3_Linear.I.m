warning off
%Jac   -0.0000   -0.0000   -0.0000    4.3226    7.6794  1e4
Par=[0     0     0     0     0
     0     -1     0     0     0
     0     0     -2     0     0
     0     0     0     -1     0
     0     0     0     0     -1]/100000;
 Par=[Par(:);zeros(75,1)];
Par=[9e4; Par];

Par=[22970.8407001069;1.50840921906657e-11;2.23039491215363e-10;1.24474273639733e-07;6.30367960269067e-08;2.25375826514706e-10;7.38474015489532e-11;-1.02730699848086e-05;3.21007886797796e-11;8.46848659838842e-11;0.000168485012182251;7.55882852924172e-11;2.16184107154934e-10;-1.44578018216778e-05;1.94883262091424e-06;2.52876104743613e-05;3.74187864913587e-05;-2.31539985153594e-11;7.35776194771328e-11;-1.04129602904801e-05;6.51617085895828e-11;2.59998171931385e-07;-1.39879482124149e-11;2.03549122763611e-11;-5.25868097013562e-11;-1.00875792177091e-05];
Par=[48991.8833728776;1.35217607631711e-11;2.25613185432883e-10;4.99104828802068e-08;8.08798757269591e-08;5.84622518007931e-10;7.58096135011960e-11;-1.24881612112393e-05;3.80291566554219e-11;8.49407737466203e-11;-5.00108936872456e-05;5.38535413686850e-11;1.01923785968334e-10;-1.53352319489835e-05;2.96034438996817e-06;3.50549994823674e-05;3.76006913921832e-05;-2.97771188739938e-11;-3.85835847151295e-11;-1.05308820270486e-05;2.91483336522873e-11;4.02498859852909e-07;-2.31659067066815e-11;2.28248690776381e-11;-5.86178225590536e-12;-1.09467422261697e-05];

Par=[10970.0033217837;2.08709840951953e-12;-1.84113962694444e-13;2.75181374058103e-06;8.12307772810206e-10;-2.69338345938234e-10;-5.38501398278460e-11;-2.11813286071538e-05;-2.83142268607092e-11;7.77804760857915e-09;0.000367148261971406;1.12578052718705e-11;-3.85431822735178e-10;-0.000105766138405822;0.000101407816571826;2.75914540226159e-05;4.23045890754069e-05;-3.92929516032029e-13;8.83067635209071e-13;-1.44972050328751e-06;3.61632962640187e-13;-9.78111208789439e-07;-4.24128895943435e-15;1.99496867167204e-11;8.95775688069899e-12;-9.65568063738929e-06]
Par=[9591.99969272528;7.16127312932288e-13;-5.07239882271427e-13;2.51364112194667e-06;3.14756514774089e-10;-5.86569693678049e-11;-6.91154827772400e-11;-2.10264665146083e-05;-1.85632942128507e-11;6.29710074920925e-09;0.000327437312956540;1.91431699350988e-11;-5.32942953483126e-10;-0.000101627235807660;9.73968332307876e-05;2.82809936046273e-05;4.20806619385109e-05;-1.96428276980870e-13;1.83716185964897e-12;-2.09921990314471e-06;3.12346119648201e-13;-9.08302964108138e-07;-1.09242131319110e-14;6.74107788995125e-12;1.93817487471366e-12;-9.68067848611973e-06]
Par=[.35*6987.41939261899;2.79505820333756e-13;-1.51321897703616e-13;2.30472276898577e-06;5.68738622916783e-10;1.35896125807686e-12;-1.30074358783606e-10;-2.61146159227307e-05;-1.29205007970398e-11;-7.20430225979339e-11;0.000159741403544645;7.50999662375180e-13;-1.12192509591167e-10;-9.74266103971988e-05;9.36219870578735e-05;2.95412346531777e-05;4.02684556909239e-05;-2.78633352853517e-14;1.08047393928892e-12;-2.64393045738380e-06;2.12776078521768e-13;-1.41722040633477e-07;-1.78601602140752e-14;7.89405100920748e-13;-1.83875358803710e-13;-1.05202732543306e-05]
Par=[.75*5862.78648763619;-2.03920665065897e-13;2.83460145327401e-14;2.22187714852117e-06;-1.91029061776681e-09;1.28696333972707e-11;-4.36837948496940e-10;-3.15393830078985e-05;-7.85642341705263e-15;3.18864232785681e-13;7.21492718260532e-05;-9.50097088320954e-15;-9.99302589425690e-13;-9.58145468767231e-05;9.20819282908811e-05;3.20692018235636e-05;4.12067112512392e-05;-4.15261141450578e-14;5.31968886149829e-13;-2.87295672465680e-06;3.15757981359991e-16;-5.47669275027506e-07;-1.99095193301165e-15;2.14299558927376e-13;-1.56260002213063e-13;-1.08404651494043e-05]
Par=[4655.01770413196/4;1.71333559453361e-14;1.08501151633941e-12;2.09603034719955e-06;9.14473489217381e-11;1.21467348906618e-10;9.43096463434977e-11;-4.52990044619545e-05;-2.35409133577360e-14;-3.53715713340364e-12;-4.88426762582301e-05;1.68643492966204e-15;1.19235078270900e-13;-9.32858368898506e-05;9.01633825335500e-05;3.81196777364899e-05;4.29507711216065e-05;7.59307007511418e-13;1.16541765084759e-14;-3.12972331048806e-06;3.85385486697921e-15;-1.29021091121790e-06;1.37040276061248e-14;8.57086956698495e-15;-7.54346887610614e-16;-1.09778424553481e-05]
Par=[1981.98663981303;8.82742738773271e-14;-7.84400266693751e-12;1.56441723608090e-06;-2.53815825437643e-12;-1.62991620640507e-10;5.67879264373260e-10;-0.000885890467527815;1.35782178792181e-16;4.09109889704690e-12;0.000806144784140496;2.09624517954204e-13;-2.12936205236638e-15;-8.16255853034447e-05;9.04274602082854e-05;3.19658346859769e-05;4.79195221871666e-05;-9.54487337109806e-13;-6.26056600112385e-16;-2.91493841938105e-06;-3.10476620322005e-15;-3.36810155612357e-06;8.25283582153209e-15;2.49937147275345e-14;-2.47927830025039e-15;-1.11464522201037e-05]
Par=[-1.83338270739302e+36;-1.26762933252050e-05;4.39546151028234e-06;-2.58057057376560e-06;3.24857422389214e-06;-4.56672825828356e-06;-5.83899647267850e-05;-0.000434512568001441;0.000156060071752002;-3.25388195627082e-05;0.000342083218687788;-4.49937690794182e-05;-4.17602891216678e-06;-0.000105499388113484;0.000105058406132567;5.77079596141795e-05;-1.40571843843556e-05;3.31225308103576e-05;-2.45249364334046e-05;1.58626956072701e-05;5.98101629978588e-06;2.95195352947362e-06;-1.13666810070944e-05;4.45611764253996e-06;-2.98917428997195e-06;-1.60555676717436e-05]

Par=[69387834.6958945;-6.32522529310969e-11;2.45935733019789e-08;1.34113331784721e-06;-1.08631474018086e-08;8.95925308485366e-07;-6.19798926731373e-06;-0.000461464560328893;1.36962318834977e-12;-8.18941112811516e-09;0.000385266954897227;3.93405511526854e-10;1.57253492734841e-11;-7.07020564839095e-05;0.000103123307314512;3.25501733057889e-05;5.22711478087978e-05;-1.08991115952177e-09;2.25142312754787e-12;1.39809699654618e-07;1.99599920425891e-12;-5.21826817167210e-06;5.61195969251754e-11;-1.20890809735299e-10;-3.07323010875062e-12;-9.70013009347104e-06]
Par=[-8.50846043014366e+19;-4.74512517739950e-06;6.34041527871361e-06;-2.50356339023382e-07;-1.37123461245618e-06;4.03914225215669e-07;-4.54871333695089e-05;-0.000449880559191203;0.000168276726200319;-3.49003332983172e-05;0.000360756573330046;-7.64900580406490e-06;-6.07517481402627e-06;-9.11317036205750e-05;8.26868321629986e-05;4.36730940180403e-05;3.50744780863702e-05;1.10478317207921e-05;1.41253406575868e-06;-1.28725998435583e-05;-6.89845707263423e-07;-4.99805705911849e-06;1.22328934994105e-06;-2.78241714429600e-06;1.70001654048328e-06;-7.84865910086591e-06]

Par=Par(2:end);
%No more par(1)=ini
Par=[-4.74512517739950e-06;6.34041527871361e-06;-2.50356339023382e-07;-1.37123461245618e-06;4.03914225215669e-07;-4.54871333695089e-05;-0.000449880559191203;0.000168276726200319;-3.49003332983172e-05;0.000360756573330046;-7.64900580406490e-06;-6.07517481402627e-06;-9.11317036205750e-05;8.26868321629986e-05;4.36730940180403e-05;3.50744780863702e-05;1.10478317207921e-05;1.41253406575868e-06;-1.28725998435583e-05;-6.89845707263423e-07;-4.99805705911849e-06;1.22328934994105e-06;-2.78241714429600e-06;1.70001654048328e-06;-7.84865910086591e-06]
Par=[-9.08325271900039e-06;1.89060108857412e-06;1.11281444410269e-08;6.51441077566018e-07;3.41494288640205e-06;-5.52492957539392e-05;-0.000455120317952113;0.000164908382137680;-3.35809852601176e-05;0.000363360499075473;-2.24346928582219e-05;-1.98018619461469e-05;-8.67855816532674e-05;9.03965567725307e-05;5.37407514099764e-05;1.52823939247211e-05;1.53027725528856e-06;3.01593755647163e-06;-2.93008121792157e-06;5.42467581908301e-06;-3.40746754247374e-06;-2.56618061947868e-06;-2.47120370437110e-06;6.00802844781644e-07;-4.99217091464651e-06]
  
%lstx*10 to force fig12 to be positive

% load('Jacwc_v2')
% 
% Par=Pars(:,15)
size(Par)
lst_ODE_model(Par,1)
drawnow

% options = optimset('Display','iter','MaxFunEvals',5000,'MaxIter',5000);
% new_par=fminsearch(@lst_ODE_model,Par,options,0)
% lst_ODE_model(new_par,1)


% % clear Lsts Pars
% new_par=Par;
% for n=20:350
% options = optimset('Display','final','MaxFunEvals',5000,'MaxIter',5000);
% new_par=fminsearch(@lst_ODE_model,new_par,options,0);
% Lsts(n)=lst_ODE_model(new_par,1);
% Pars(:,n)=new_par;
% figure(100); plot(Lsts);title('Jacwc-v2')
% drawnow
% save('Jacwc_v2')
% end

return

function z=lst_ODE_model(Par,g)
ok=0; lst1=0; lsti=0; lstx=0;
% ini=floor(Par(1))*0;
% Par=Par(2:end);
% ini(ini>9e4)=9e4;
% ini(ini<0)=0;
ini=0;

load('Met_Pathwayv2_S80000_P20000_Q20000_noDil');
temp=output(:,5);
output(:,5)=output(:,6);
output(:,6)=temp;

Tspan=ini:100000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6,'Events',@odeEvents);
tic
% output(ini+1,2:end)
[t,y] = ode15s(@MetPathODE,Tspan,output(ini+1,2:end),options,Par); %[80000 20000 20000 10 10]
if or(t(end)<Tspan(end),any(imag(y)>0))
    ok=ok+1e14;
end    
   if ok==0 
    if g==1
        figure(10)
        newcolors = [0.83 0.14 0.14
            1.00 0.54 0.00
            0.47 0.25 0.80
            0.25 0.80 0.54
            0.54 0.54 0.54];
        
        colororder(newcolors)
        plot(t,y, 'LineWidth', 1.5)
        hold on
        plot(output(:,1),output(:,2:end),'--', 'LineWidth', 1.5)
        hold off
        legend('S','P','Q','R','T')
             
    end
    
    dadosS=interp1(t,y,output(:,1));
    lst=(dadosS-output(:,2:end)).^2;
    lst(isnan(lst))=0;
    lst1=sum(sum(lst));
    if any(y<0,'All')
        lst1=lst1*10;
        'negativos'
    end
   end
   %%

load('Met_Pathwayv2_S80000_P20000_Q20000_Dil0005In1.mat');
temp=output(:,5);
output(:,5)=output(:,6);
output(:,6)=temp;

Tspan=0:50000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6);
[t,y] = ode15s(@MetPathODE_flow,Tspan,[80000 20000 20000 10 10],options,Par,[1 0.0005]);
if t(end)<Tspan(end)
    ok=ok+1e12
end

if g==1
    figure(11)
    newcolors = [0.83 0.14 0.14
             1.00 0.54 0.00
             0.47 0.25 0.80
             0.25 0.80 0.54
             0.54 0.54 0.54];
         
         colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    hold on
    plot(output(:,1),output(:,2:end),'--', 'LineWidth', 1.5)
    hold off
    assignin('base','output',output(1:2000:end,:))
assignin('base','ty',[t(1:500:end) y(1:500:end,:)])   
end

dadosS=interp1(t,y,output(:,1));
lst=(dadosS-output(:,2:end)).^2;
lst(isnan(lst))=0;
lst2=sum(sum(lst));
if any(y<0,'All')
        lst2=lst2*10;
        'negativos'
end

%%

Tspan=0:50000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6);
[t,y] = ode15s(@MetPathODE_flow,Tspan,[80000 20000 20000 10 10],options,Par,[.1 0.0005]);
if t(end)<Tspan(end)
    ok=ok+3e12
end
if g==1
    figure(12)
    newcolors = [0.83 0.14 0.14
             1.00 0.54 0.00
             0.47 0.25 0.80
             0.25 0.80 0.54
             0.54 0.54 0.54];
         
         colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    ylim([-1000 4000])
    
end
if any(y<0,'All')
        lstx=lstx+sum(sum(((y<0).*y).^2));
%         'negativos .1'
end
%%

Tspan=0:50000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6);
[t,y] = ode15s(@MetPathODE_flow,Tspan,[80000 20000 20000 10 10],options,Par,[.5 0.0005]);
if t(end)<Tspan(end)
    ok=ok+4e12
end
if g==1
    figure(13)
    newcolors = [0.83 0.14 0.14
             1.00 0.54 0.00
             0.47 0.25 0.80
             0.25 0.80 0.54
             0.54 0.54 0.54];
         
         colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    ylim([0 3000])
    
end
if any(y<0,'All')
        lstx=lstx+sum(sum(((y<0).*y).^2));
%         'negativos .5'
end
%%

%%
% lsti=ini*1e5;
lsti=ini*2e7;

if g==1
    [lst1 lst2 lsti lstx*10]
end

z=lst1+lst2+lsti+lstx*10+ok;
end

function dxdt=MetPathODE(t,x,p) %This is the ODE function
ss=[0.0000   0.0000   0.0000    4.3226    7.6794]*1e4;
Pr=reshape(p(1:25),5,5);
% H=reshape(p(26:100),5,15);

X=(x-ss');


dxdt=Pr*X;

end
function dxdt=MetPathODE_flow(t,x,p,flow) %This is the ODE function
in=flow(1);
dil=flow(2);
ss=[0.0000   0.0000   0.0000    4.3226    7.6794]*1e4;
Pr=reshape(p(1:25),5,5);
% H=reshape(p(26:100),5,15);

X=(x-ss');

dxdt=Pr*X;

dxdt(1)=dxdt(1)+in;
dxdt=dxdt-x*dil;

end
function [value,isterminal,direction] = odeEvents(t,y,Par,SSa)
x=toc-10;
if x<0
    x=0;
end

value = x;     % Detect height = 0
isterminal = 1;   % Stop the integration
direction = 0;   
end
