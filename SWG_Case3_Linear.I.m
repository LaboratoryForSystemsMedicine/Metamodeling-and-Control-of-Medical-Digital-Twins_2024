
% Par=[rand(3,3)-.5];
% while eig(Par)<=0
%     Par=[rand(3,3)-.5];
%     eig(Par)
%     eig(Par)>=0
% end
Par=[-1   0    0
    0    -1    0
    0    0    -1]/20
eig(Par)
Par=[1300 ; Par(:) ]

% Par=[2944.15442169975;-2.98175858551876e-14;-0.0179056441229320;-0.0187708592695009;-0.00468942481616477;3.30432143038304e-14;-0.00180279017849674;-0.115298567914332;0.000756475086183901;-0.0292289774694053]
% Par=[1150;9.82197024071247e-12;-0.00164991685714275;-0.167243373402088;2.98842761043816e-13;-4.07285622290399e-12;-0.674388799787506;-1.62612833801190;0.368421221614146;-1.23356869906155]
% Par=[1149.99999504052;4.03959121503902e-08;-0.00169002503204293;-0.158409861267001;-9.14434232220204e-10;1.79872790464276e-08;-0.643834308452206;-45.4904263431282;10.2730831395465;-33.2285874281423]

% Par=[-1160.70429231131;-3.49625122409052e-11;-0.0136735277929372;-0.0173088348815515;9.23226808340280e-14;-8.74979819336150e-12;-0.0348212104567235;-1.06540192518227;0.288598474894004;-0.293463050053473]

% Par=[1150;-0.0127724529022116;0.00226087445905129;-0.00959286704550199;0.0359065714230389;-0.0138978563262556;-0.0138800900333315;0.132601228413600;-0.0371329702138128;0.00726902915398588]
% Par=[4149.81742314137;-0.000979834322878542;-0.00196592460403318;-0.00740285126358304;0.0965571329346197;-0.0301731877475831;-0.00440664473113090;0.269311729714582;-0.0677823028523620;0.00750955257110172]
% Par=[10262.99979079021;-0.00156959782386284;-0.00205390339373521;-0.00699656485808270;0.165830199453785;-0.0534552380812199;-0.000648325849773609;0.238221167526340;-0.0296221894853707;6.86635114091144e-05]
% Par=[12751.9999999772;-0.000242519276330398;-0.00139388977480856;-0.00385966172124176;0.125335007882861;-0.0381802557367847;-0.000209105286993547;0.323296721411542;-0.0758859057847351;9.12591701117287e-05]
% Par=[12751.9999004883;0.000458366742340728;-0.00182372487794823;-0.00391488546168783;0.125299158276595;-0.0381558817507843;-0.000643708680447918;0.321378624369444;-0.0757308169053687;6.38638995915618e-05]
% Par=[16748.0001979188;0.00122204724552223;-0.00335570272795003;-0.00427913427749465;0.126743628615456;-0.0437143940794957;-0.00134760036075716;0.312338377514473;-0.0763704487511453;0.000214509714063967]
% Par=[18169.1191704489;0.000780985230418725;-0.00387413542895233;-0.00425316862295700;0.122254071512148;-0.0453631957332017;-0.00119141960159057;0.310464718852599;-0.0787680046327095;0.000282080925467867]
% Par=[12751.6159718791;0.000823660812228596;-0.00492969774871677;-0.00417008259225986;0.119149706355450;-0.0486761844632604;-0.00106973816110126;0.315775601791559;-0.0837303972215331;0.000148210642903775]


Par=[977.644821277652;-0.0910115638699311;0.00633989864043619;-0.0161181653868454;-0.00253776468403597;-0.131854573834401;-0.00603122502627370;0.00278250622539609;0.0104427131888253;-0.0275826049150809]
Par=[1703.000000000506;-0.0387331803058636;-0.0457261168718606;-0.0263928430452419;0.0169704585622415;-0.541111934906862;-0.0788113918593173;0.145892818161702;-0.330985869844378;-0.0231354968114775]
Par=[3071.15698244580;-0.108403702023101;-0.188279403417887;-0.131939558126043;-0.259745550806353;-1.02185591878558;-0.625995895541759;0.354747216281695;-0.359092234090660;-0.132208117147580]
Par=[8517.00044222969;-0.0980330147224711;-0.186562383295247;-0.120974717638373;-0.158072884482136;-1.00837601560204;-0.560748563232026;0.465934050222315;-0.401115498993385;-0.120193689888009]
Par=[8326.00000735514;0.00410758800400106;-0.244335549851644;-0.139449375496257;0.237778939262167;-0.972417327020174;-0.486812884559246;0.414192235928196;-0.376834832562044;-0.113366365291848]
% Par=[9988.00468732651;0.00455495793276537;-0.256473204016332;-0.152630115267813;0.108838294309979;-0.998499377477540;-0.564496712990921;0.290397968152648;-0.383756307784144;-0.187436067192634]
% Par=[9992.99995035601;0.0394791627011924;-0.261623295092187;-0.156623311575457;0.217542990894531;-0.952203171803383;-0.543107431214100;0.333714749667715;-0.398483616833020;-0.197485650206864]
% Par=[16789.00000538151;-0.331454857951189;-0.239181973667923;-0.0581986696036994;-1.34327667551495;-1.14710405603553;-0.247437648949700;-0.565466908870346;-0.790277668868639;-0.151368155168271]
% Par=[14904.0000088936;-0.227937895022621;-0.419733955468327;-0.0607442620997697;-0.828309066362394;-1.76115617264809;-0.234912912150684;-0.138997894145959;-0.831492156658078;-0.105273539975416]

Par=[8195.00001903094;0.00435995657191463;-0.243664593238492;-0.141783334689556;0.241607925893849;-0.951226370159500;-0.484584486174828;0.431740850662331;-0.373681481079097;-0.111465500693656]
Par=[8482.99992920505;0.00481963463353849;-0.243681354238733;-0.141757170835063;0.241578346746388;-0.950735695052026;-0.484548107891062;0.431758671221038;-0.373788633276809;-0.111567772230918]
Par=[9464.00000122146;0.00546087007279109;-0.241459397655596;-0.143416886173236;0.240010283746222;-0.927830352676421;-0.482669804975225;0.435934564140121;-0.381618135040345;-0.117921166700314]
Par=[12592.99952171661;0.00522874242066933;-0.232424329507417;-0.145606662564632;0.242286494628705;-0.901738352142163;-0.493434706281299;0.445154443782100;-0.392393318649514;-0.130321907166159]
Par=[14023.0000460492;0.00504624268771712;-0.168346657151685;-0.0971187240238074;0.153625728633007;-0.751222199244175;-0.397177215132817;0.311046921624082;-0.339027171080256;-0.149781539726326]
Par=[11292.0008878129;0.00799089466279145;-0.159484131320668;-0.0922674812785495;0.148762431840079;-0.667984607155647;-0.352613719930252;0.311526831571821;-0.339892048038388;-0.150294308963974]

%1
Par=[18502.9999920058;-0.0108602738140264;-0.143774444892968;-0.0943292891082067;0.219102179542697;-0.715987315855501;-0.386778656506418;0.499191368221418;-0.491480124222709;-0.186691242407596]
Par=[18500.0000059558;-0.0121724621183834;-0.145334512126294;-0.0953590382695606;0.210991613783303;-0.716410789395016;-0.387698758738244;0.492763222863393;-0.487615473257733;-0.184848752291979]
Par=[18500.0837185223;-0.00914072359042850;-0.153380916052977;-0.0947625069882004;0.201972470861953;-0.732229127692162;-0.378357359329708;0.457183533210302;-0.465665395336238;-0.169010781072987]

Par=[18500.9999995758;0.00158343093932763;-0.245567046724825;-0.140226735699282;0.215437992240055;-0.970455947510032;-0.489291872710397;0.392411991061069;-0.366769833199979;-0.112980916390845]
Par=[1077.99999955943;-0.0208658412966867;-0.00144759026706619;-0.0287103376929477;0.00124686823700983;-0.126275437380863;0.0386019680009095;0.0519356998268798;-0.00661133211051785;-0.00567626454317002]
Par=[1170.99000814070;-0.0163456871931757;-0.00609375708097154;-0.00922444720270158;0.00193072385097747;-0.0729909420560515;-0.00565369794131103;0.184304336947129;-0.00942651772950483;-0.000606381036238688]
Par=[6170.99987925835;-0.0229458857389296;-0.0344934080952983;-0.00274833055712624;-0.00129780873124382;-0.181494863162276;0.0128412838070555;0.304527391214215;-0.112510907703601;0.00751401467216324]
Par=[6398.99945109534;-0.0525680411044120;-0.0475524176141405;-0.00856583707777519;0.000703714829425954;-0.379468000993122;-0.0117781199499392;0.505458040442434;-0.367378445337135;0.0215813243976836]
Par=[10746.0018991969;-0.0547677161565709;-0.0463467097752307;-0.00790440810571501;0.00144842604168895;-0.268589950192973;-0.00558259492682604;0.349165220219133;-0.227012025445625;0.0168763674021963]
Par=[18500.1684040456;-0.0551141516653179;-0.0460140789270023;-0.00791328007162725;0.00109654290768036;-0.267922433217750;-0.00542472251693909;0.349550381226324;-0.226668399828616;0.0172144722940750]
Par=[18500.9261258696;-0.0557616865685696;-0.0469497583567672;-0.00799806148001728;0.000590344653822088;-0.272019997913726;-0.00539849236863877;0.350624840609530;-0.227772580186865;0.0177233430167444]
Par=[18500.0002106727;-0.0531680410249922;-0.0464706312973534;-0.00785451223377784;0.000133489352694774;-0.270427611528254;-0.00479917470584026;0.333916097071607;-0.227361444830694;0.0175969929695567]

% %2
% % Par=[18829.9999484388;-0.0106253391304992;-0.0540289605656181;-0.00247529718836717;9.30950792641474e-05;-0.317633223563271;0.00495883206641657;0.320181139056069;-0.314071015806930;-0.00543655492100374]
% % Par=[1170.99000814070;-0.0163456871931757;-0.00609375708097154;-0.00922444720270158;0.00193072385097747;-0.0729909420560515;-0.00565369794131103;0.184304336947129;-0.00942651772950483;-0.000606381036238688]
% % Par=[2318.00076949906;-0.0208136654625248;-0.000542548336798963;-0.00231800955111644;0.00380017249751706;-0.0250066759900568;0.00917839419507201;0.447232671399712;-0.0611129332191064;0.000416678761566327]
% % Par=[6317.00347622400;-0.0351732587876910;-0.00209261749162063;0.00694999282410393;0.00233437350772250;-0.0405255073408789;0.0431619881582943;0.746015101817232;-0.146647774936964;0.000173034860838120]
% % Par=[8948.85195262994;-0.0861623238382310;0.000562275162237020;0.0133595113594221;0.0183763979144752;-0.0620139035026088;0.0822139399132349;1.08478597415567;-0.157137386717121;-0.000478312445569669]
% % Par=[12881.06134148896;-0.125000264694239;0.000449153603621311;0.0264267311857015;0.0106941012328892;-0.0891212957026402;0.0824662763241222;0.756081198224019;-0.195521869247456;-0.000161203836869651]
% % Par=[4687.64371498572;-0.111230997694227;0.000584734230722824;0.0569855156814410;-0.00323225311180818;-0.0854805245470148;0.203489733239571;0.566005781408851;-0.138829000175444;-9.19857099551875e-05]
% % Par=[6749.89572571519;-0.100245849570681;0.000484116917018082;0.0676414915791107;-0.000787128069659993;-0.0857951508204046;0.209607779105492;0.554394084097260;-0.168118592945034;-9.61461872140135e-05]
% % Par=[8026.36701753117;-0.0920732904655206;0.000700470642970112;0.0745046705698083;-0.00103914915741934;-0.0817093121741863;0.208722823308286;0.524558449359191;-0.181700651661590;8.53658991042127e-05]
% % Par=[8114.99744154860;-0.0543640613458882;0.00207154578043603;0.172228094980624;0.00536525757512204;-0.0493365116616981;0.480136299502299;0.260500942411295;-0.0958368539163731;0.000197199809280112]
% % Par=[8642.34221683136;-0.0279471894414698;0.00258121042982142;0.211522942719323;0.0373795491832807;-0.0358298230236769;0.547199177908227;0.197372942896724;-0.0791387146041439;0.000371652248163548]
% % Par=[8642.93013576677;-0.0180424512865289;0.00232464577165590;0.212641588612864;0.0495645131450721;-0.0313830939427838;0.554776875864228;0.186407072983373;-0.0742224638154028;0.00110140374578353]
% 
% Par=[18825.9999751871;-0.00784989271604996;-0.130867471646456;-0.00700976566888521;-0.000694697361971004;-0.539157187936327;-0.0102271959915594;0.218011012531404;-0.355909919355014;-0.0183355273999919]
% Par=[12201.0000080666;-0.0233342011086662;-0.351342820145054;-0.00627456984741565;0.00453683326564901;-1.10698165787806;-0.00991807314466399;0.270794630602651;-1.29055661875217;-0.0158605094065266]
% Par=[9001.99905000354;-0.0350808987252728;-0.0719055526361640;-0.00795472849363444;0.0108780395602271;-0.285994260312689;-0.0126929487051069;0.279282513847719;-0.217137803832608;-0.00266894444427015]
% Par=[8993.00052033006;-0.0345200955378125;-0.0710513313073579;-0.00793116172830367;0.0139650991290587;-0.283848929886362;-0.0126079775143306;0.282194108782496;-0.210996166510762;-0.00217845826662370]
% Par=[9001.99972264560;-0.0331981506917605;-0.0701712414440596;-0.00787356379308228;0.0188848399433582;-0.282752047035653;-0.0125356720693489;0.285523128731497;-0.208646563391974;-0.00198605625759528]




% close all
lst_ODE_model(Par,1)
drawnow; pause(2)

% options = optimset('Display','iter','MaxFunEvals',3000,'MaxIter',3000);
% new_par=fminsearch(@lst_ODE_model,Par,options,0)
% lst_ODE_model(new_par,1)
% 
% zp=reshape(new_par(2:end),[3 3]);
% double(int16(zp*1000))
% eig(zp)

return

function z=lst_ODE_model(Par,g)

dist=floor(abs(Par(1)));
% dist=4150;
if dist<300 dist=300;end
Par=Par(2:end);



ok=0;lst1=0;lst2=0;lstl1=0;
% Par([11 12 ])=0;

load('Dados01')
SS=mean(Ya(900:1000,:));
Da=vecnorm(Ya-repmat(SS,1001,1),2,2);
Daa=Da(end:-1:1);
Taa=Ta(end:-1:1);
s=find(Daa>dist);
if isempty(s)
    Ti=1;
else
Ti=Taa(s(1))+1;
end
if Ti<50; Ti=50;end

SSa=SS
    
Tspan=Ti:1000;
options = odeset('RelTol',1e-6,'AbsTol',1e-6);     
[t,y] = ode45(@ODE_SWG,Tspan,[Ya(Tspan(1),:) ],options,Par,SSa);
if t(end)<Tspan(end)
    ok=1e12
end
Yss=y(end,:);
if g==1
    newcolors = [0.25 0.80 0.54;0.7 0.7 0.7;0.83 0.14 0.14];
         
    
    figure(1)
    colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    
    hold on
    plot(Ta,Ya,'--', 'LineWidth', 1.5)
    hold off
    legend('grass','sheep','wolves')
%     y(end,:)
% [y]
end
dadosS=interp1(t,y,Ta);
lst=(dadosS-Ya).^2;
NP=sum(sum(~isnan(lst)))/3;
lst(isnan(lst))=0;
WLSQ1=sum(sum(lst,1)./(SSa*NP));
lst1=sum(sum(lst));

load('Dados02')

SS=mean(Ya(1900:2000,:));
Da=vecnorm(Ya(1001:2001,:)-repmat(SS,1001,1),2,2);
Daa=Da(end:-1:1);
Taa=Ta(end:-1:1);
s=find(Daa>dist);
if isempty(s)
    Ti=1;
else
Ti=Taa(s(1))+1;
end
if Ti<1051; Ti=1051;end

Tspan=Ti:2000;
     
[t,y] = ode45(@ODE_SWG,Tspan,[Ya(Tspan(1),:)],options,Par,SSa);
if t(end)<Tspan(end)
    ok=1e12
end

if g==1
    figure(2)
    colororder(newcolors)
    plot(Ta(1000:end),Ya(1000:end,:),'--', 'LineWidth', 1.5)
    hold on
    plot(t,y, 'LineWidth', 1.5)
    hold off
    legend('grass','sheep','wolves')
    xlim([1000 2000])
%     y(end,:)
end
dadosS=interp1(t,y,Ta);
lst=(dadosS-Ya).^2;
NP=sum(sum(~isnan(lst)))/3;
lst(isnan(lst))=0;
WLSQ2=sum(sum(lst,1)./(SSa*NP));
lst2=sum(sum(lst));


load('Dados03')
load('Dados03s')
Tspan=1000:2000;
     
[t,y] = ode45(@ODE_SWG_wC,Tspan,Yss,options,Par,SSa);
if t(end)<Tspan(end)
    ok=1e12
end

if g==1

    figure(3)
    colororder(newcolors)
    plot(t,y, 'LineWidth', 1.5)
    hold on
    plot(Ta(1000:2000),Ya(1000:2000,:),'--', 'LineWidth', 1.5)
    plot(Ta(1000:2000),Ya(1000:2000,:)+3*Yas(1000:2000,:),'--', 'LineWidth', 1)
    plot(Ta(1000:2000),Ya(1000:2000,:)-3*Yas(1000:2000,:),'--', 'LineWidth', 1)
    
    hold off
    legend('grass','sheep','wolves')
    xlim([1000 2000])
%     y
end

dadosS=interp1(t,y,Ta);
lst=(dadosS-Ya).^2;
lst(isnan(lst))=0;
WLSQ3=sum(sum(lst,1)./(sum(Ya)));
lst3=sum(sum(lst));


lstl1=1e3*abs(18500-dist);
Wlstl1=1e-4*abs(18500-dist);


if g==1 disp([lst1 lst2 lst3*0 lstl1]);end
% if g==1 disp([WLSQ1 WLSQ2 WLSQ3 Wlstl1]);end

z=lst1*0+lst2*1+lst3*0+lstl1+ok;
% z=WLSQ1*0+WLSQ2*1+WLSQ3*0+Wlstl1+ok;
end

function dxdt=ODE_SWG(t,x,p,ss) %This is the ODE function
K=255*255;

Pr=reshape(p,3,3);

dxdt=Pr*(x-ss');

end
function dxdt=ODE_SWG_wC(t,x,p,ss) %This is the ODE function
K=255*255;

u=0;
if t>1500 u=.01; end

Pr=reshape(p,3,3);

dxdt=Pr*(x-ss');

dxdt(3)=dxdt(3)-u*x(3);

end
